<!--
BetterHelp Challenge
Step 1: Database
Political season is upon us. For this challenge, pretend that you are working for your candidate of choice, trying to help them determine which voters to spend the most time on fundraising.

Given the tables below, write a SQL query that returns:

Name
Date of most recent donation (if any)
Political Party guess as: R, D, or U, where:
R = Likely Republican (more republican donations than other donations)
D = Likely Democrat (more democrat donations than other donations)
U = Undtermined (no donations on record, or R and D are tied for first place.
Address
Tables:

People
    ID
    Name
    Address
Donations
    ID
    People_ID
    Donation_Date
    Party (1 = Republican, -1 = Democrat)
Enter your SQL query below:

Step 2: Javascript
For some reason, this form is submitted via AJAX, but there are a couple of bugs preventing that from working. Use your browser's console to fix it.

Submit
Results:

Here's my SQL:

CREATE FUNCTION PartyAffiliation(in pid int)
RETURNS varchar(50)
language plpgsql
as
$$
declare
dCount integer;
rCount integer;
party varchar(50);
BEGIN
SELECT count(*) INTO rCount from donations where donations.people_id = pid AND donations.party = 1;
SELECT count(*) INTO dCount from donations where donations.people_id = pid AND donations.party = -1;
if rCount > dCount then
return 'R';
elsif rCount < dCount then
return 'D';
else
return 'U';
end if;

END;
$$

SELECT people.name AS "Name", max(donations.donation_date) AS "Most Recent Donation", PartyAffiliation(people.id) AS "Political Party Guess", people.address AS "Address"
FROM donations
JOIN people
ON people.id = donations.people_id
GROUP BY
people.id, people.name, people.address
ORDER BY
people.id;
And the changes to your html:

1. On button, remove the onclick handler reference.
2. On form, change action="post" to method="post"
3. On the onclick handler, change the jquery JSON.stringify({prop: $('text_area').val() to 'textarea'.
4. For the ajax call:
$.ajax({ url: 'ajax.php',
type: 'POST',
dataType: 'json',
contentType: "application/json;charset=utf-8",
then I added an error function:
error: function(request, error) { alert("Request: " + JSON.stringify(request) } });

However, something in intercepting the onclick method and I don't seem to get beyond the interception.

Answers
Are you able to work in the US without any visa sponsorship for the next 5 years?
Yes


Please go to http://212.47.247.139/challenge/ and follow the instructions
CREATE FUNCTION PartyAffiliation(in pid int)
RETURNS varchar(50)
language plpgsql
as
$$
declare
dCount integer;
rCount integer;
party varchar(50);
BEGIN
SELECT count(*) INTO rCount from donations where donations.people_id = pid AND donations.party = 1;
SELECT count(*) INTO dCount from donations where donations.people_id = pid AND donations.party = -1;
if rCount > dCount then
return 'R';
elsif rCount < dCount then
return 'D';
else
return 'U';
end if;

END;
$$

SELECT people.name AS "Name", max(donations.donation_date) AS "Most Recent Donation", PartyAffiliation(people.id) AS "Political Party Guess", people.address AS "Address"
FROM donations
JOIN people
ON people.id = donations.people_id
GROUP BY
people.id, people.name, people.address
ORDER BY
people.id;
And the changes to your html:

1. On button, remove the onclick handler reference.
2. On form, change action="post" to method="post"
3. On the onclick handler, change the jquery JSON.stringify({prop: $('text_area').val() to 'textarea'.
4. For the ajax call:
$.ajax({ url: 'ajax.php',
type: 'POST',
dataType: 'json',
contentType: "application/json;charset=utf-8",
then I added an error function:
error: function(request, error) { alert("Request: " + JSON.stringify(request) } });

However, something in intercepting the onclick method and I don't seem to get beyond the interception.
-->
